# 网络通信

TCP/IP协议是一个协议簇。里面包括很多协议的，UDP只是其中的一个， 之所以命名为TCP/IP协议，因为TCP、IP协议是两个很重要的协议，就用他两命名了。

TCP/IP协议集包括应用层,传输层，网络层，网络访问层。

**其中应用层包括:**
1、超文本传输协议（HTTP）:万维网的基本协议；
2、文件传输（TFTP简单文件传输协议）；
3、远程登录（Telnet），提供远程访问其它主机功能, 它允许用户登录internet主机，并在这台主机上执行命令；
4、网络管理（SNMP简单网络管理协议），该协议提供了监控网络设备的方法， 以及配置管理,统计信息收集,性能管理及安全管理等；
5、域名系统（DNS），该系统用于在internet中将域名及其公共广播的网络节点转换成IP地址。

**其次网络层包括:**
1、Internet协议（IP）；
2、Internet控制信息协议（ICMP）；
3、地址解析协议（ARP）；
4、反向地址解析协议（RARP）。

**最后说网络访问层:**
网络访问层又称作主机到网络层（host-to-network），网络访问层的功能包括IP地址与物理地址硬件的映射， 以及将IP封装成帧.基于不同硬件类型的网络接口，网络访问层定义了和物理介质的连接。TCP/IP协议本来就是一门学问，每一个分支都是一个很复杂的流程，有必要去仔细了解一番。

## UDP

用户数据包协议（User Datagram Protocol），简称 UDP，是基于 IP 之上开发能和应用打交道的协议。

UDP 传输缺陷：

* 数据包在传输过程容易丢失
* 大文件传输中，UDP 并不知道如何组成这些数据包，不知道如何还原成完整的文件。

UDP 不能保证数据可靠性，但是传输速度却非常快

## TCP

TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。

TCP的2个特点：

* 对于数据包的丢失，建立重传机制
* TCP 引入数据包排序机制，用来保证把乱序的数据包组合成一个完整的文件

### TCP 连接

* '三次握手四次挥手'

1. 建立连接阶段

所谓 三次握手，是指在建立一个 TCP 连接时，客户端和服务器总共要发送 3 个数据包来确认连接的建立。
三次握手主要作用是：

* 确认双方的接收能力和发送能力
* 指定自己的初始化序列号，为后面的可靠性做准备

  1. 客户端发送到服务器。客户端发送 SYN 报文给服务器，并且指明客户端初始化序列号为 ISN(c)，即以 SYN=1, seq=x 的形式发送过去。此时客户端处于 SYN_SEND 状态。
  2. 服务器发送给客户端。服务器收到客户端的 SYN 和 ISN(c)，也发送一个 SYN 回去，同时设置 ACK = ISN(c) + 1 以及指明服务器初始化序列号为 ISN(s)，即以 SYN=1, ACK=x+1， seq=y 的形式发送给客户端。
  3. 客户端发送到服务器。客户端收到服务器发送的消息后，设置 ACK = ISN(s) + 1，将自身的 ISN(c) + 1，即以 ACK=y+1, seq=x+1 的形式发送给服务器。此时客户端处于 ESTABLISHED 阶段，服务器收到报文，也处于 ESTABLISHED 阶段，双方建立了连接。

[缺图]

* 问题：两次握手不行吗？

2. 传输数据阶段

此时客户端和服务器都处于 ESTABLISHED 状态。
这个阶段中，接收端需要对每个数据包进行确认操作。即接收端在接收到数据包之后，需要发送确认数据包给发送端。
如果发送端在规定时间内没有接收到接收端的反馈确认消息，那么判断丢包（数据包丢失），从而触发自身的重发机制。
一个大的文件在传输过程中会被拆分为多个小的数据包，接收端按照 TCP 头中的序号进行排序，保证组成完整的数据。

3. 断开连接阶段

数据传输完毕之后，需要终止连接，通过 四次挥手 来保证双方都能断开连接。

1. 客户端发送给服务器。客户端以 FIN=1, seq=u 的形式发送给服务器，表示需要关闭客户端和服务器的数据传输。此时客户端处于 FIN_WAIT 状态。
2. 服务器发送给客户端。服务器收到信息，先返回 ACK 给客户端，即以 ACK=1, seq=v, ack=u+1 的形式返回给客户端，表示收到客户端报文了。此时服务器处于 CLOST_WAIT 状态。
3. 服务器发送给客户端。服务器等待一会，看客户端还有没有数据没发过来，等处理完这些数据之后，也想断开连接了，于是发送 FIN 给客户端，即以 FIN=1, ACK=1, seq=w, ack=u+1 的形式发送给客户端。此时服务器处于 LAST_ACK 状态。
4. 客户端发送给服务器。客户端收到 FIN 之后，返回 ACK 报文作为应答，即以 ACK=1, seq=w+1 的形式发送给服务器。此时客户端处于 TIME_WAIT 状态。

[缺图]

* 问题：为什么需要四次挥手？
因为一些数据存在网络延迟等问题没有发送到，直接关闭会导致数据没有接收到，或者发送数据给客户端，确保数据发送完。

## TCP 和 UDP 的区别

1. TCP 是面向连接的，UDP 是无连接的即发送数据前不需要先建立链接。
2. TCP 提供可靠的服务。也就是说，通过 TCP 连接传送的数据，无差错，不丢失，不重复，且按序到达；UDP尽最大努力交付，即不保证可靠交付。并且因为 TCP 可靠，面向连接，不会丢失数据因此适合大数据量的交换。
3. TCP 是面向字节流，UDP 面向报文，并且网络出现拥塞不会使得发送速率降低（因此会出现丢包，对实时的应用比如 IP 电话和视频会议等）。
4. TCP 只能是 1对1 的，UDP 支持 1对1，1对多。
5. TCP 的首部较大为 20 字节，而 UDP 只有 8 字节。
6. TCP 是面向连接的可靠性传输，而 UDP 是不可靠的。
